<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>THE MASTER ROOT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

<style>
body {
  margin: 0;
  background: #020617;
  color: #f8fafc;
  font-family: monospace;
}
header {
  padding: 10px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
select {
  background: #0f172a;
  color: white;
  border: 1px solid #1e293b;
  padding: 6px;
}
#chart {
  width: 100vw;
  height: calc(100vh - 50px);
}
.info {
  position: fixed;
  bottom: 10px;
  left: 10px;
  background: #0f172a;
  border: 1px solid #1e293b;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
}
</style>
</head>

<body>

<header>
  <strong>THE MASTER ROOT</strong>
  <select id="asset">
    <option value="ETHUSDT">ETH / USDT</option>
    <option value="BTCUSDT">BTC / USDT</option>
  </select>
</header>

<div id="chart"></div>
<div class="info" id="state">LOADING…</div>

<script>
const container = document.getElementById('chart');

const chart = LightweightCharts.createChart(container, {
  width: container.clientWidth,
  height: container.clientHeight,
  layout: {
    background: { color: '#020617' },
    textColor: '#94a3b8'
  },
  grid: {
    vertLines: { color: '#0f172a' },
    horzLines: { color: '#0f172a' }
  },
  timeScale: { timeVisible: true }
});

const candles = chart.addCandlestickSeries({
  upColor: '#22d3ee',
  downColor: '#f43f5e',
  borderVisible: false,
  wickUpColor: '#22d3ee',
  wickDownColor: '#f43f5e'
});

const rootLine = chart.addLineSeries({
  color: '#22d3ee',
  lineWidth: 2
});

const liqLine = chart.addLineSeries({
  color: '#f97316',
  lineWidth: 2,
  lineStyle: 2
});

window.addEventListener('resize', () => {
  chart.applyOptions({
    width: container.clientWidth,
    height: container.clientHeight
  });
});

let DATA = [];
let SYMBOL = 'ETHUSDT';

async function load(symbol) {
  document.getElementById('state').innerText = 'LOADING…';
  DATA = [];

  const r = await fetch(
    `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1h&limit=300`
  );
  const d = await r.json();

  DATA = d.map(c => ({
    time: c[0] / 1000,
    open: +c[1],
    high: +c[2],
    low: +c[3],
    close: +c[4]
  }));

  candles.setData(DATA);
  calculateRoot();
}

function calculateRoot() {
  const root = [];
  const liq = [];

  for (let i = 0; i < DATA.length; i++) {
    const slice = DATA.slice(Math.max(0, i - 30), i + 1);
    const avg = slice.reduce((a, b) => a + b.close, 0) / slice.length;
    const dev = Math.sqrt(
      slice.reduce((a, b) => a + Math.pow(b.close - avg, 2), 0) / slice.length
    );

    root.push({ time: DATA[i].time, value: avg });
    liq.push({ time: DATA[i].time, value: avg - dev * 1.5 });
  }

  rootLine.setData(root);
  liqLine.setData(liq);

  const last = DATA.at(-1).close;
  const lastRoot = root.at(-1).value;

  document.getElementById('state').innerText =
    last > lastRoot ? 'TREND UP' : 'ACCUMULO / RANGE';
}

document.getElementById('asset').addEventListener('change', e => {
  SYMBOL = e.target.value;
  load(SYMBOL);
});

load(SYMBOL);
</script>

</body>
</html>
