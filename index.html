<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE MASTER ROOT - Multi-Asset</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'JetBrains Mono', monospace; }
        #chart { width: 100%; height: 55vh; background: #020617; border-radius: 1rem; }
        .panel { background: #0f172a; border: 1px solid #1e293b; border-radius: 1rem; }
        .btn-active { background: #22d3ee !important; color: #020617 !important; font-weight: bold; }
    </style>
</head>
<body class="p-2 md:p-4">

    <div class="max-w-6xl mx-auto">
        <div class="panel p-4 mb-3 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-xl font-bold text-white italic">THE MASTER ROOT <span id="assetTitle" class="text-cyan-400">ETH/USDT</span></h1>
                <p class="text-[9px] text-slate-500 uppercase tracking-widest">Teoria delle Radici di Marco</p>
            </div>
            <div class="flex gap-2 bg-slate-900 p-1 rounded-lg">
                <button onclick="changeAsset('ETHUSDT')" id="btnETH" class="px-4 py-2 text-xs rounded-md transition btn-active">ETH</button>
                <button onclick="changeAsset('BTCUSDT')" id="btnBTC" class="px-4 py-2 text-xs rounded-md transition text-slate-400">BTC</button>
            </div>
        </div>

        <div id="errorMessage" class="hidden bg-red-900/50 border border-red-500 text-red-200 p-2 mb-2 text-xs rounded-lg text-center"></div>

        <div id="chart" class="mb-4 shadow-2xl"></div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
            <div class="panel p-4"><p class="text-[10px] text-slate-500 uppercase">Distanza Swap</p><p id="dist" class="text-xl font-bold">--%</p></div>
            <div class="panel p-4"><p class="text-[10px] text-slate-500 uppercase">Profitto Radice</p><p id="prof" class="text-xl font-bold text-cyan-400">--%</p></div>
            <div class="panel p-4"><p class="text-[10px] text-slate-500 uppercase">Prezzo Live</p><p id="price" class="text-xl font-bold text-white">--</p></div>
            <div class="panel p-4 border-l-4 border-yellow-500"><p class="text-[10px] text-slate-500 uppercase">Stato AI</p><p id="state" class="text-sm font-bold text-yellow-500">CONNETTENDO...</p></div>
        </div>
    </div>

    <script>
        let currentSymbol = 'ETHUSDT';
        let chartObj, candleSeries, rootLine, liqLine, ws;
        let candleData = [];

        function initChart() {
            const chartElement = document.getElementById('chart');
            chartObj = LightweightCharts.createChart(chartElement, {
                layout: { backgroundColor: '#020617', textColor: '#94a3b8' },
                grid: { vertLines: { color: '#0f172a' }, horzLines: { color: '#0f172a' } },
                timeScale: { borderColor: '#1e293b', timeVisible: true },
                priceScale: { borderColor: '#1e293b' }
            });

            candleSeries = chartObj.addCandlestickSeries({ upColor: '#22d3ee', downColor: '#f43f5e', borderVisible: false });
            rootLine = chartObj.addLineSeries({ color: '#22d3ee', lineWidth: 2, title: 'Radice' });
            liqLine = chartObj.addLineSeries({ color: '#f97316', lineWidth: 2, lineStyle: 2, title: 'LiquiditÃ ' });
        }

        async function loadHistory(symbol) {
            try {
                document.getElementById('errorMessage').classList.add('hidden');
                const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1h&limit=150`);
                if (!response.ok) throw new Error("Binance API non risponde");
                
                const data = await response.json();
                candleData = data.map(d => ({
                    time: d[0] / 1000,
                    open: parseFloat(d[1]), high: parseFloat(d[2]),
                    low: parseFloat(d[3]), close: parseFloat(d[4])
                }));
                
                candleSeries.setData(candleData);
                updateCalculations();
                connectWebSocket(symbol);
            } catch (err) {
                document.getElementById('errorMessage').innerText = "ERRORE: " + err.message;
                document.getElementById('errorMessage').classList.remove('hidden');
            }
        }

        function updateCalculations() {
            if (candleData.length < 20) return;
            
            const lastCandle = candleData[candleData.length - 1];
            
            const rootPoints = candleData.map((d, i) => {
                const slice = candleData.slice(Math.max(0, i - 20), i + 1);
                const avg = slice.reduce((a, b) => a + b.close, 0) / slice.length;
                return { time: d.time, value: avg };
            });

            rootLine.setData(rootPoints);
            liqLine.setData(rootPoints.map(p => ({ time: p.time, value: p.value * 0.96 })));

            const currentRoot = rootPoints[rootPoints.length - 1].value;
            const currentLiq = currentRoot * 0.96;
            const dist = (((currentRoot - currentLiq) / currentLiq) * 100).toFixed(2);
            const prof = (((lastCandle.close - currentRoot) / currentRoot) * 100).toFixed(2);

            document.getElementById('price').innerText = "$" + lastCandle.close.toLocaleString();
            document.getElementById('dist').innerText = dist + "%";
            document.getElementById('prof').innerText = prof + "%";
            document.getElementById('state').innerText = prof > 10 ? "ZONA PROFITTO" : "ACCUMULO RADICE";
        }

        function connectWebSocket(symbol) {
            if (ws) ws.close();
            ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@kline_1h`);
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                const k = msg.k;
                const candle = { time: k.t / 1000, open: parseFloat(k.o), high: parseFloat(k.h), low: parseFloat(k.l), close: parseFloat(k.c) };
                
                if (candleData[candleData.length - 1].time === candle.time) {
                    candleData[candleData.length - 1] = candle;
                } else {
                    candleData.push(candle);
                }
                candleSeries.update(candle);
                updateCalculations();
            };
        }

        function changeAsset(symbol) {
            currentSymbol = symbol;
            document.getElementById('assetTitle').innerText = symbol === 'ETHUSDT' ? 'ETH/USDT' : 'BTC/USDT';
            document.getElementById('btnETH').classList.toggle('btn-active', symbol === 'ETHUSDT');
            document.getElementById('btnBTC').classList.toggle('btn-active', symbol === 'BTCUSDT');
            loadHistory(symbol);
        }

        // Avvio
        initChart();
        loadHistory(currentSymbol);
    </script>
</body>
</html>
