<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MASTER ROOT 1M</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

<style>
body {
  margin:0;
  background:#020617;
  color:#f8fafc;
  font-family: monospace;
}
header {
  padding:8px 12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
select {
  background:#0f172a;
  color:white;
  border:1px solid #1e293b;
  padding:4px;
}
#chart {
  width:100vw;
  height:calc(100vh - 40px);
}
</style>
</head>

<body>

<header>
  <strong>MASTER ROOT · 1M</strong>
  <select id="asset">
    <option value="BTCUSDT">BTC/USDT</option>
    <option value="ETHUSDT">ETH/USDT</option>
  </select>
</header>

<div id="chart"></div>

<script>
const container = document.getElementById('chart');

const chart = LightweightCharts.createChart(container, {
  width: container.clientWidth,
  height: container.clientHeight,
  layout: {
    background: { color: '#020617' },
    textColor: '#94a3b8'
  },
  grid: {
    vertLines: { color: '#0f172a' },
    horzLines: { color: '#0f172a' }
  },
  timeScale: {
    timeVisible: true,
    secondsVisible: true
  }
});

const candles = chart.addCandlestickSeries({
  upColor:'#22d3ee',
  downColor:'#f43f5e',
  borderVisible:false,
  wickUpColor:'#22d3ee',
  wickDownColor:'#f43f5e'
});

const rootLine = chart.addLineSeries({
  color:'#22d3ee',
  lineWidth:2
});

const liqLine = chart.addLineSeries({
  color:'#f97316',
  lineWidth:2,
  lineStyle:2
});

window.addEventListener('resize', () => {
  chart.applyOptions({
    width: container.clientWidth,
    height: container.clientHeight
  });
});

let DATA = [];
let SYMBOL = 'BTCUSDT';

async function load(symbol) {
  DATA = [];

  const r = await fetch(
    `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1m&limit=500`
  );
  const d = await r.json();

  DATA = d.map(c => ({
    time: c[0] / 1000,
    open:+c[1],
    high:+c[2],
    low:+c[3],
    close:+c[4]
  }));

  candles.setData(DATA);
  chart.timeScale().fitContent();
  calculateRoot();
}

function calculateRoot() {
  const root = [];
  const liq = [];
  const markers = [];

  const LEN = 14;      // corto → visibile
  const FACTOR = 1.2;  // aggressivo

  for (let i = 0; i < DATA.length; i++) {
    const slice = DATA.slice(Math.max(0, i - LEN), i + 1);
    const avg = slice.reduce((a,b)=>a+b.close,0) / slice.length;

    const dev = Math.sqrt(
      slice.reduce((a,b)=>a+Math.pow(b.close-avg,2),0) / slice.length
    );

    root.push({ time: DATA[i].time, value: avg });
    liq.push({ time: DATA[i].time, value: avg - dev * FACTOR });

    if (i > LEN) {
      const prev = DATA[i-1];
      const curr = DATA[i];

      if (prev.close < avg && curr.close > avg) {
        markers.push({
          time: curr.time,
          position: 'belowBar',
          color: '#22d3ee',
          shape: 'arrowUp',
          text: 'BUY'
        });
      }

      if (prev.close > avg && curr.close < avg) {
        markers.push({
          time: curr.time,
          position: 'aboveBar',
          color: '#f43f5e',
          shape: 'arrowDown',
          text: 'SELL'
        });
      }
    }
  }

  rootLine.setData(root);
  liqLine.setData(liq);
  candles.setMarkers(markers);
}

document.getElementById('asset').addEventListener('change', e => {
  SYMBOL = e.target.value;
  load(SYMBOL);
});

load(SYMBOL);
</script>

</body>
</html>
