<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE MASTER ROOT - ETH Real-Time</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: monospace; }
        #chart { width: 100%; height: 60vh; background: #020617; }
        .panel { background: #0f172a; border: 1px solid #1e293b; }
    </style>
</head>
<body class="p-2">

    <div class="max-w-6xl mx-auto">
        <div class="panel p-4 mb-2 flex justify-between items-center rounded-xl">
            <h1 class="text-xl font-bold text-cyan-400">THE MASTER ROOT - ETH/USDT</h1>
            <div id="status" class="text-xs text-green-500 font-bold">‚óè LIVE</div>
        </div>

        <div id="chart" class="rounded-xl overflow-hidden mb-4 border border-slate-800"></div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
            <div class="panel p-3 rounded-xl"><p class="text-[10px] text-slate-500">DISTANZA</p><p id="dist" class="font-bold">--</p></div>
            <div class="panel p-3 rounded-xl"><p class="text-[10px] text-slate-500">PROFITTO BALENE</p><p id="prof" class="font-bold text-cyan-400">--</p></div>
            <div class="panel p-3 rounded-xl"><p class="text-[10px] text-slate-500">PREZZO ATTUALE</p><p id="price" class="font-bold text-white">--</p></div>
            <div class="panel p-3 rounded-xl"><p class="text-[10px] text-slate-500">STATO</p><p id="state" class="font-bold text-yellow-500 italic">CARICAMENTO...</p></div>
        </div>
    </div>

    <script>
        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
            layout: { backgroundColor: '#020617', textColor: '#94a3b8' },
            grid: { vertLines: { visible: false }, horzLines: { color: '#0f172a' } },
            timeScale: { borderColor: '#1e293b' },
        });

        const candleSeries = chart.addCandlestickSeries({ upColor: '#00ffcc', downColor: '#ff4444' });
        const rootLine = chart.addLineSeries({ color: '#22d3ee', lineWidth: 2 });
        const liqLine = chart.addLineSeries({ color: '#f97316', lineWidth: 2, lineStyle: 2 });

        let candleData = [];

        // Funzione per caricare i dati iniziali via Proxy per evitare il blocco
        async function loadData() {
            try {
                const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1h&limit=100`);
                const json = await res.json();
                candleData = json.map(d => ({
                    time: d[0] / 1000,
                    open: parseFloat(d[1]), high: parseFloat(d[2]),
                    low: parseFloat(d[3]), close: parseFloat(d[4])
                }));
                candleSeries.setData(candleData);
                updateIndicators();
            } catch (e) {
                document.getElementById('state').innerText = "ERRORE CONNESSIONE";
            }
        }

        function updateIndicators() {
            const last = candleData[candleData.length - 1];
            const rootVal = candleData.slice(-20).reduce((a, b) => a + b.close, 0) / 20;
            const liqVal = rootVal * 0.97;

            // Aggiorna Linee
            const rootPoints = candleData.map((d, i) => {
                const slice = candleData.slice(Math.max(0, i-20), i+1);
                const avg = slice.reduce((a, b) => a + b.close, 0) / slice.length;
                return { time: d.time, value: avg };
            });
            rootLine.setData(rootPoints);
            liqLine.setData(rootPoints.map(p => ({ time: p.time, value: p.value * 0.97 })));

            // Dashboard
            const dist = (((rootVal - liqVal) / liqVal) * 100).toFixed(2);
            const prof = (((last.close - rootVal) / rootVal) * 100).toFixed(2);

            document.getElementById('price').innerText = "$" + last.close.toFixed(2);
            document.getElementById('dist').innerText = dist + "%";
            document.getElementById('prof').innerText = prof + "%";
            document.getElementById('state').innerText = prof > 10 ? "ZONA VENDITA" : "ACCUMULO";
        }

        // WebSocket per aggiornamento real-time
        const ws = new WebSocket('wss://stream.binance.com:9443/ws/ethusdt@kline_1h');
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            const k = msg.k;
            const newCandle = {
                time: k.t / 1000,
                open: parseFloat(k.o), high: parseFloat(k.h),
                low: parseFloat(k.l), close: parseFloat(k.c)
            };
            
            if (candleData.length > 0 && candleData[candleData.length - 1].time === newCandle.time) {
                candleData[candleData.length - 1] = newCandle;
            } else {
                candleData.push(newCandle);
            }
            candleSeries.update(newCandle);
            updateIndicators();
        };

        loadData();
    </script>
</body>
</html>
