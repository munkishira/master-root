<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>THE MASTER ROOT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

<style>
body {
  margin: 0;
  background: #020617;
  color: #f8fafc;
  font-family: monospace;
}
header {
  padding: 10px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
select, button {
  background: #0f172a;
  color: white;
  border: 1px solid #1e293b;
  padding: 6px 8px;
}
#chart {
  width: 100vw;
  height: calc(100vh - 120px);
}
.panel {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  padding: 8px;
}
.box {
  background: #0f172a;
  border: 1px solid #1e293b;
  border-radius: 8px;
  padding: 8px;
  text-align: center;
  font-size: 12px;
}
.green { color:#22d3ee }
.red { color:#f43f5e }
.yellow { color:#facc15 }
</style>
</head>

<body>

<header>
  <strong>THE MASTER ROOT</strong>
  <div>
    <select id="asset">
      <option value="ETHUSDT">ETH / USDT</option>
      <option value="BTCUSDT">BTC / USDT</option>
    </select>
    <button onclick="exportSignals()">EXPORT JSON</button>
  </div>
</header>

<div id="chart"></div>

<div class="panel">
  <div class="box">STATO<br><span id="state" class="yellow">--</span></div>
  <div class="box">WINRATE<br><span id="winrate">--%</span></div>
  <div class="box">PNL<br><span id="pnl">--%</span></div>
  <div class="box">SEGNALI<br><span id="count">--</span></div>
</div>

<script>
const container = document.getElementById('chart');

const chart = LightweightCharts.createChart(container, {
  width: container.clientWidth,
  height: container.clientHeight,
  layout: {
    background: { color: '#020617' },
    textColor: '#94a3b8'
  },
  grid: {
    vertLines: { color: '#0f172a' },
    horzLines: { color: '#0f172a' }
  },
  timeScale: { timeVisible: true }
});

const candles = chart.addCandlestickSeries({
  upColor:'#22d3ee',
  downColor:'#f43f5e',
  borderVisible:false,
  wickUpColor:'#22d3ee',
  wickDownColor:'#f43f5e'
});

const rootLine = chart.addLineSeries({
  color:'#22d3ee',
  lineWidth:2
});

const liqLine = chart.addLineSeries({
  color:'#f97316',
  lineWidth:2,
  lineStyle:2
});

const buyMarkers = [];
const sellMarkers = [];

window.addEventListener('resize', () => {
  chart.applyOptions({
    width: container.clientWidth,
    height: container.clientHeight
  });
});

let DATA = [];
let SIGNALS = [];
let SYMBOL = 'ETHUSDT';

async function load(symbol) {
  DATA = [];
  SIGNALS = [];
  buyMarkers.length = 0;
  sellMarkers.length = 0;

  const r = await fetch(
    `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1h&limit=300`
  );
  const d = await r.json();

  DATA = d.map(c => ({
    time: c[0] / 1000,
    open:+c[1], high:+c[2], low:+c[3], close:+c[4]
  }));

  candles.setData(DATA);
  calculateMasterRoot();
  backtest();
}

function calculateMasterRoot() {
  const root = [];
  const liq = [];

  const LEN = 30;
  const FACTOR = 1.5;

  for (let i = 0; i < DATA.length; i++) {
    const slice = DATA.slice(Math.max(0, i - LEN), i + 1);
    const avg = slice.reduce((a,b)=>a+b.close,0) / slice.length;
    const dev = Math.sqrt(
      slice.reduce((a,b)=>a+Math.pow(b.close-avg,2),0) / slice.length
    );

    root.push({ time: DATA[i].time, value: avg });
    liq.push({ time: DATA[i].time, value: avg - dev * FACTOR });

    if (i > LEN) {
      const prev = DATA[i-1];
      const curr = DATA[i];

      if (prev.close < avg && curr.close > avg) {
        SIGNALS.push({ time: curr.time, type:'BUY', price: curr.close });
        buyMarkers.push({
          time: curr.time,
          position: 'belowBar',
          color: '#22d3ee',
          shape: 'arrowUp',
          text: 'BUY'
        });
      }

      if (prev.close > avg && curr.close < avg) {
        SIGNALS.push({ time: curr.time, type:'SELL', price: curr.close });
        sellMarkers.push({
          time: curr.time,
          position: 'aboveBar',
          color: '#f43f5e',
          shape: 'arrowDown',
          text: 'SELL'
        });
      }
    }
  }

  rootLine.setData(root);
  liqLine.setData(liq);
  candles.setMarkers([...buyMarkers, ...sellMarkers]);

  const last = DATA.at(-1).close;
  document.getElementById('state').innerText =
    last > root.at(-1).value ? 'TREND UP' : 'ACCUMULO / DOWN';
}

function backtest() {
  let entry = null;
  let wins = 0;
  let loss = 0;
  let pnl = 0;

  SIGNALS.forEach(s => {
    if (s.type === 'BUY') entry = s.price;
    if (s.type === 'SELL' && entry) {
      const r = (s.price - entry) / entry * 100;
      pnl += r;
      r > 0 ? wins++ : loss++;
      entry = null;
    }
  });

  const total = wins + loss;

  document.getElementById('winrate').innerText =
    total ? ((wins/total)*100).toFixed(1)+'%' : '--';

  document.getElementById('pnl').innerText = pnl.toFixed(2)+'%';
  document.getElementById('count').innerText = SIGNALS.length;
}

function exportSignals() {
  const blob = new Blob(
    [JSON.stringify(SIGNALS, null, 2)],
    { type: 'application/json' }
  );
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'master-root-signals.json';
  a.click();
}

document.getElementById('asset').addEventListener('change', e => {
  SYMBOL = e.target.value;
  load(SYMBOL);
});

load(SYMBOL);
</script>

</body>
</html>
